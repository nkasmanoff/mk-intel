<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mario Kart Race Analysis</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0a0a1a;
    color: #e0e0e0;
    min-height: 100vh;
}

/* Header */
.header {
    background: rgba(10, 10, 26, 0.95);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid #2a2a4a;
    padding: 1.2rem 2rem;
    position: sticky;
    top: 0;
    z-index: 100;
}
.header h1 {
    font-size: 1.6rem;
    background: linear-gradient(135deg, #e94560, #ffd700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.header .subtitle {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.2rem;
}

/* Summary bar */
.summary-bar {
    display: flex;
    gap: 1rem;
    padding: 1.2rem 2rem;
    flex-wrap: wrap;
}
.summary-card {
    flex: 1;
    min-width: 140px;
    background: #12122a;
    border: 1px solid #2a2a4a;
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
}
.summary-card .big {
    font-size: 2rem;
    font-weight: 800;
    color: #ffd700;
}
.summary-card .label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #666;
    margin-top: 0.3rem;
}

/* Race cards */
.races-container {
    padding: 0 2rem 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
}
.race-card {
    background: #12122a;
    border: 1px solid #2a2a4a;
    border-radius: 12px;
    overflow: hidden;
    transition: border-color 0.2s;
}
.race-card:hover {
    border-color: #e94560;
}
.race-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.2rem;
    border-bottom: 1px solid #1e1e3a;
}
.race-card-header h3 {
    color: #e94560;
    font-size: 1.1rem;
}
.race-duration {
    color: #666;
    font-size: 0.85rem;
    font-family: monospace;
}
.race-stats {
    display: flex;
    gap: 0.5rem;
    padding: 0.8rem 1.2rem;
    flex-wrap: wrap;
}
.stat {
    flex: 1;
    min-width: 60px;
    text-align: center;
}
.stat-val {
    font-size: 1.4rem;
    font-weight: 700;
    color: #ffd700;
}
.stat-val.final-pos { color: #e94560; }
.stat-val.best-pos { color: #00ff88; }
.stat-val.worst-pos { color: #ff6b6b; }
.stat-label {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #555;
    margin-top: 2px;
}
.chart-container {
    padding: 0.5rem 1rem 1rem;
    height: 280px;
}

/* Final positions bar chart */
.overview-section {
    padding: 0 2rem 1.5rem;
}
.overview-card {
    background: #12122a;
    border: 1px solid #2a2a4a;
    border-radius: 12px;
    padding: 1.2rem;
}
.overview-card h3 {
    color: #e94560;
    margin-bottom: 0.8rem;
    font-size: 1rem;
}
.overview-chart-container {
    height: 250px;
}

/* Timeline */
.timeline-section {
    padding: 0 2rem 2rem;
}
.timeline-card {
    background: #12122a;
    border: 1px solid #2a2a4a;
    border-radius: 12px;
    padding: 1.2rem;
}
.timeline-card h3 {
    color: #e94560;
    margin-bottom: 0.8rem;
    font-size: 1rem;
}
.timeline-chart-container {
    height: 200px;
}

/* Frame preview modal */
.frame-preview-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(8px);
    z-index: 200;
    justify-content: center;
    align-items: center;
}
.frame-preview-overlay.active {
    display: flex;
}
.frame-preview {
    background: #12122a;
    border: 1px solid #e94560;
    border-radius: 16px;
    padding: 1.5rem;
    max-width: 800px;
    width: 90%;
    position: relative;
}
.frame-preview-close {
    position: absolute;
    top: 0.8rem;
    right: 1rem;
    background: none;
    border: none;
    color: #e94560;
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 10;
    transition: color 0.2s;
}
.frame-preview-close:hover {
    color: #fff;
}
.frame-preview video {
    width: 100%;
    border-radius: 8px;
    margin-bottom: 0.8rem;
    background: #000;
}
.frame-preview-info {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    padding: 0.5rem 0;
}
.frame-preview-info .info-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.2rem;
}
.frame-preview-info .info-label {
    color: #666;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.frame-preview-info .info-value {
    color: #ffd700;
    font-weight: 700;
    font-size: 1.1rem;
}
.chart-hint {
    text-align: center;
    font-size: 0.7rem;
    color: #444;
    padding: 0.2rem 0 0;
    font-style: italic;
}
</style>
</head>
<body>

<div class="header">
    <h1>Mario Kart Race Analysis</h1>
    <div class="subtitle">1 race(s) detected from 139 frames &mdash; gameplaytrimmed.mp4</div>
</div>

<div class="summary-bar">
    <div class="summary-card">
        <div class="big">1</div>
        <div class="label">Races</div>
    </div>
    <div class="summary-card">
        <div class="big">1.0</div>
        <div class="label">Avg Finish</div>
    </div>
    <div class="summary-card">
        <div class="big">1</div>
        <div class="label">Wins</div>
    </div>
    <div class="summary-card">
        <div class="big">1</div>
        <div class="label">Podiums</div>
    </div>
    <div class="summary-card">
        <div class="big">132s</div>
        <div class="label">Total Race Time</div>
    </div>
</div>

<!-- Overview: final positions across races -->


<!-- Full session timeline -->
<div class="timeline-section">
    <div class="timeline-card">
        <h3>Session Timeline (scene classification)</h3>
        <div class="timeline-chart-container">
            <canvas id="chart-timeline"></canvas>
        </div>
    </div>
</div>

<!-- Per-race cards -->
<div class="races-container">

        <div class="race-card" data-race="1">
            <div class="race-card-header">
                <h3>Race 1</h3>
                <span class="race-duration">132s</span>
            </div>
            <div class="race-stats">
                <div class="stat">
                    <div class="stat-val final-pos">1st</div>
                    <div class="stat-label">Final</div>
                </div>
                <div class="stat">
                    <div class="stat-val best-pos">1st</div>
                    <div class="stat-label">Best</div>
                </div>
                <div class="stat">
                    <div class="stat-val worst-pos">5th</div>
                    <div class="stat-label">Worst</div>
                </div>
                <div class="stat">
                    <div class="stat-val">1.2</div>
                    <div class="stat-label">Avg</div>
                </div>
                <div class="stat">
                    <div class="stat-val">4</div>
                    <div class="stat-label">Changes</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="chart-race-1"></canvas>
            </div>
            <div class="chart-hint">Click any point to preview video frame</div>
        </div>
</div>

<!-- Frame preview modal -->
<div class="frame-preview-overlay" id="frame-preview-overlay">
    <div class="frame-preview">
        <button class="frame-preview-close" onclick="closeFramePreview()">&times;</button>
        <video id="frame-preview-video" preload="metadata" controls></video>
        <div class="frame-preview-info" id="frame-preview-info"></div>
    </div>
</div>

<script>
const RACES = [{"race_number": 1, "start_time": 1, "end_time": 133, "duration": 132, "total_frames": 138, "in_race_frames": 138, "position_history": [{"timestamp": 7, "position": 1, "relative_time": 6}, {"timestamp": 8, "position": 1, "relative_time": 7}, {"timestamp": 9, "position": 1, "relative_time": 8}, {"timestamp": 10, "position": 1, "relative_time": 9}, {"timestamp": 11, "position": 1, "relative_time": 10}, {"timestamp": 12, "position": 1, "relative_time": 11}, {"timestamp": 13, "position": 1, "relative_time": 12}, {"timestamp": 14, "position": 1, "relative_time": 13}, {"timestamp": 15, "position": 1, "relative_time": 14}, {"timestamp": 15, "position": 1, "relative_time": 14}, {"timestamp": 16, "position": 1, "relative_time": 15}, {"timestamp": 17, "position": 1, "relative_time": 16}, {"timestamp": 18, "position": 1, "relative_time": 17}, {"timestamp": 19, "position": 1, "relative_time": 18}, {"timestamp": 20, "position": 2, "relative_time": 19}, {"timestamp": 21, "position": 2, "relative_time": 20}, {"timestamp": 22, "position": 2, "relative_time": 21}, {"timestamp": 23, "position": 2, "relative_time": 22}, {"timestamp": 24, "position": 2, "relative_time": 23}, {"timestamp": 26, "position": 2, "relative_time": 25}, {"timestamp": 27, "position": 2, "relative_time": 26}, {"timestamp": 28, "position": 2, "relative_time": 27}, {"timestamp": 29, "position": 2, "relative_time": 28}, {"timestamp": 30, "position": 2, "relative_time": 29}, {"timestamp": 31, "position": 2, "relative_time": 30}, {"timestamp": 32, "position": 2, "relative_time": 31}, {"timestamp": 33, "position": 2, "relative_time": 32}, {"timestamp": 34, "position": 2, "relative_time": 33}, {"timestamp": 35, "position": 2, "relative_time": 34}, {"timestamp": 36, "position": 2, "relative_time": 35}, {"timestamp": 37, "position": 2, "relative_time": 36}, {"timestamp": 38, "position": 2, "relative_time": 37}, {"timestamp": 39, "position": 2, "relative_time": 38}, {"timestamp": 40, "position": 2, "relative_time": 39}, {"timestamp": 41, "position": 2, "relative_time": 40}, {"timestamp": 42, "position": 1, "relative_time": 41}, {"timestamp": 43, "position": 1, "relative_time": 42}, {"timestamp": 44, "position": 1, "relative_time": 43}, {"timestamp": 44, "position": 1, "relative_time": 43}, {"timestamp": 45, "position": 1, "relative_time": 44}, {"timestamp": 46, "position": 1, "relative_time": 45}, {"timestamp": 47, "position": 1, "relative_time": 46}, {"timestamp": 48, "position": 1, "relative_time": 47}, {"timestamp": 49, "position": 1, "relative_time": 48}, {"timestamp": 50, "position": 1, "relative_time": 49}, {"timestamp": 51, "position": 1, "relative_time": 50}, {"timestamp": 52, "position": 1, "relative_time": 51}, {"timestamp": 54, "position": 1, "relative_time": 53}, {"timestamp": 55, "position": 1, "relative_time": 54}, {"timestamp": 56, "position": 1, "relative_time": 55}, {"timestamp": 57, "position": 1, "relative_time": 56}, {"timestamp": 58, "position": 1, "relative_time": 57}, {"timestamp": 59, "position": 1, "relative_time": 58}, {"timestamp": 60, "position": 1, "relative_time": 59}, {"timestamp": 61, "position": 1, "relative_time": 60}, {"timestamp": 62, "position": 1, "relative_time": 61}, {"timestamp": 63, "position": 1, "relative_time": 62}, {"timestamp": 64, "position": 1, "relative_time": 63}, {"timestamp": 65, "position": 1, "relative_time": 64}, {"timestamp": 66, "position": 1, "relative_time": 65}, {"timestamp": 67, "position": 1, "relative_time": 66}, {"timestamp": 68, "position": 1, "relative_time": 67}, {"timestamp": 69, "position": 1, "relative_time": 68}, {"timestamp": 70, "position": 1, "relative_time": 69}, {"timestamp": 71, "position": 1, "relative_time": 70}, {"timestamp": 72, "position": 1, "relative_time": 71}, {"timestamp": 73, "position": 1, "relative_time": 72}, {"timestamp": 75, "position": 1, "relative_time": 74}, {"timestamp": 76, "position": 1, "relative_time": 75}, {"timestamp": 77, "position": 1, "relative_time": 76}, {"timestamp": 78, "position": 1, "relative_time": 77}, {"timestamp": 79, "position": 1, "relative_time": 78}, {"timestamp": 80, "position": 1, "relative_time": 79}, {"timestamp": 81, "position": 1, "relative_time": 80}, {"timestamp": 82, "position": 1, "relative_time": 81}, {"timestamp": 83, "position": 1, "relative_time": 82}, {"timestamp": 84, "position": 1, "relative_time": 83}, {"timestamp": 85, "position": 1, "relative_time": 84}, {"timestamp": 86, "position": 1, "relative_time": 85}, {"timestamp": 87, "position": 1, "relative_time": 86}, {"timestamp": 89, "position": 1, "relative_time": 88}, {"timestamp": 90, "position": 1, "relative_time": 89}, {"timestamp": 92, "position": 1, "relative_time": 91}, {"timestamp": 93, "position": 1, "relative_time": 92}, {"timestamp": 94, "position": 1, "relative_time": 93}, {"timestamp": 95, "position": 1, "relative_time": 94}, {"timestamp": 96, "position": 1, "relative_time": 95}, {"timestamp": 97, "position": 1, "relative_time": 96}, {"timestamp": 98, "position": 1, "relative_time": 97}, {"timestamp": 99, "position": 1, "relative_time": 98}, {"timestamp": 100, "position": 1, "relative_time": 99}, {"timestamp": 101, "position": 1, "relative_time": 100}, {"timestamp": 102, "position": 1, "relative_time": 101}, {"timestamp": 102, "position": 1, "relative_time": 101}, {"timestamp": 103, "position": 1, "relative_time": 102}, {"timestamp": 104, "position": 1, "relative_time": 103}, {"timestamp": 105, "position": 1, "relative_time": 104}, {"timestamp": 106, "position": 1, "relative_time": 105}, {"timestamp": 107, "position": 1, "relative_time": 106}, {"timestamp": 108, "position": 1, "relative_time": 107}, {"timestamp": 109, "position": 1, "relative_time": 108}, {"timestamp": 110, "position": 1, "relative_time": 109}, {"timestamp": 111, "position": 1, "relative_time": 110}, {"timestamp": 112, "position": 1, "relative_time": 111}, {"timestamp": 113, "position": 1, "relative_time": 112}, {"timestamp": 114, "position": 1, "relative_time": 113}, {"timestamp": 115, "position": 1, "relative_time": 114}, {"timestamp": 116, "position": 1, "relative_time": 115}, {"timestamp": 117, "position": 1, "relative_time": 116}, {"timestamp": 118, "position": 1, "relative_time": 117}, {"timestamp": 119, "position": 1, "relative_time": 118}, {"timestamp": 120, "position": 1, "relative_time": 119}, {"timestamp": 121, "position": 1, "relative_time": 120}, {"timestamp": 122, "position": 1, "relative_time": 121}, {"timestamp": 123, "position": 1, "relative_time": 122}, {"timestamp": 124, "position": 1, "relative_time": 123}, {"timestamp": 125, "position": 1, "relative_time": 124}, {"timestamp": 126, "position": 1, "relative_time": 125}, {"timestamp": 127, "position": 1, "relative_time": 126}, {"timestamp": 129, "position": 5, "relative_time": 128}, {"timestamp": 130, "position": 1, "relative_time": 129}, {"timestamp": 131, "position": 1, "relative_time": 130}, {"timestamp": 131, "position": 1, "relative_time": 130}, {"timestamp": 132, "position": 1, "relative_time": 131}], "best_position": 1, "worst_position": 5, "final_position": 1, "avg_position": 1.2, "position_changes": 4}];
const FRAMES = [{"timestamp": 0, "scene": "not_in_race", "position": null, "raw_scene": "not_in_race", "raw_position": ""}, {"timestamp": 1, "scene": "in_race", "position": null, "raw_scene": "in_race", "raw_position": "Final Race"}, {"timestamp": 2, "scene": "in_race", "position": null, "raw_scene": "in_race", "raw_position": "Final Race"}, {"timestamp": 3, "scene": "in_race", "position": null, "raw_scene": "in_race", "raw_position": "Final Race"}, {"timestamp": 4, "scene": "in_race", "position": null, "raw_scene": "in_race", "raw_position": "Finish Line"}, {"timestamp": 5, "scene": "in_race", "position": null, "raw_scene": "in_race", "raw_position": "Finish Line"}, {"timestamp": 6, "scene": "in_race", "position": null, "raw_scene": "in_race", "raw_position": "Finish Line"}, {"timestamp": 7, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1"}, {"timestamp": 8, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1"}, {"timestamp": 9, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1"}, {"timestamp": 10, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1"}, {"timestamp": 11, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1"}, {"timestamp": 12, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1"}, {"timestamp": 13, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1"}, {"timestamp": 14, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 15, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 15, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 16, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 17, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 18, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 19, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 20, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2nd"}, {"timestamp": 21, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2nd"}, {"timestamp": 22, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2nd"}, {"timestamp": 23, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2"}, {"timestamp": 24, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2nd"}, {"timestamp": 25, "scene": "in_race", "position": null, "raw_scene": "in_race", "raw_position": ""}, {"timestamp": 26, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2"}, {"timestamp": 27, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2nd"}, {"timestamp": 28, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2nd"}, {"timestamp": 29, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2nd"}, {"timestamp": 30, "scene": "in_race", "position": 2, "raw_scene": "", "raw_position": "", "imputed": true}, {"timestamp": 31, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2"}, {"timestamp": 32, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2nd"}, {"timestamp": 33, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2nd"}, {"timestamp": 34, "scene": "in_race", "position": 2, "raw_scene": "", "raw_position": "", "imputed": true}, {"timestamp": 35, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2nd"}, {"timestamp": 36, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2"}, {"timestamp": 37, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2nd"}, {"timestamp": 38, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2nd"}, {"timestamp": 39, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2nd"}, {"timestamp": 40, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2"}, {"timestamp": 41, "scene": "in_race", "position": 2, "raw_scene": "in_race", "raw_position": "2"}, {"timestamp": 42, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 43, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 44, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 44, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 45, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 46, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 47, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 48, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 49, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 50, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 51, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 52, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 53, "scene": "in_race", "position": null, "raw_scene": "in_race", "raw_position": ""}, {"timestamp": 54, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 55, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 56, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 57, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 58, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1"}, {"timestamp": 59, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 60, "scene": "in_race", "position": 1, "raw_scene": "", "raw_position": "", "imputed": true}, {"timestamp": 61, "scene": "in_race", "position": 1, "raw_scene": "", "raw_position": "", "imputed": true}, {"timestamp": 62, "scene": "in_race", "position": 1, "raw_scene": "", "raw_position": "", "imputed": true}, {"timestamp": 63, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 64, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 65, "scene": "in_race", "position": 1, "raw_scene": "", "raw_position": "", "imputed": true}, {"timestamp": 66, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 67, "scene": "in_race", "position": 1, "raw_scene": "", "raw_position": "", "imputed": true}, {"timestamp": 68, "scene": "in_race", "position": 1, "raw_scene": "", "raw_position": "", "imputed": true}, {"timestamp": 69, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 70, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 71, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 72, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 73, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 73, "scene": "in_race", "position": null, "raw_scene": "in_race", "raw_position": ""}, {"timestamp": 74, "scene": "in_race", "position": null, "raw_scene": "in_race", "raw_position": ""}, {"timestamp": 75, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 76, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 77, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 78, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 79, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 80, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 81, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 82, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 83, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 84, "scene": "in_race", "position": 1, "raw_scene": "", "raw_position": "", "imputed": true}, {"timestamp": 85, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 86, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 87, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 88, "scene": "in_race", "position": null, "raw_scene": "in_race", "raw_position": ""}, {"timestamp": 89, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 90, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 91, "scene": "in_race", "position": null, "raw_scene": "in_race", "raw_position": ""}, {"timestamp": 92, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 93, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 94, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 95, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 96, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1"}, {"timestamp": 97, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 98, "scene": "in_race", "position": 1, "raw_scene": "not_in_race", "raw_position": "", "imputed": true}, {"timestamp": 99, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 100, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 101, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 102, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 102, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 103, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 104, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 105, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 106, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 107, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 108, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 109, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 110, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 111, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 112, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 113, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 114, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 115, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 116, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 117, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 118, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 119, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 120, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 121, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 122, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 123, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 124, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 125, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 126, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 127, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1st"}, {"timestamp": 128, "scene": "in_race", "position": null, "raw_scene": "in_race", "raw_position": "23"}, {"timestamp": 129, "scene": "in_race", "position": 5, "raw_scene": "in_race", "raw_position": "5"}, {"timestamp": 130, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1"}, {"timestamp": 131, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1"}, {"timestamp": 131, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1"}, {"timestamp": 132, "scene": "in_race", "position": 1, "raw_scene": "in_race", "raw_position": "1"}, {"timestamp": 133, "scene": "in_race", "position": null, "raw_scene": "in_race", "raw_position": "Sky Kingdom"}];

// Chart.js defaults for dark theme
Chart.defaults.color = '#888';
Chart.defaults.borderColor = '#2a2a4a';

// -- Helper: ordinal --
function ordinal(n) {
    if (n == null) return '?';
    const s = ['th','st','nd','rd'];
    const v = n % 100;
    return n + (s[(v-20)%10] || s[v] || 'th');
}

// -- Per-race position charts --
RACES.forEach(race => {
    const ctx = document.getElementById('chart-race-' + race.race_number);
    if (!ctx || !race.position_history.length) return;

    const labels = race.position_history.map(p => p.relative_time);
    const data = race.position_history.map(p => p.position);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Position',
                data: data,
                borderColor: '#e94560',
                backgroundColor: 'rgba(233, 69, 96, 0.1)',
                borderWidth: 2.5,
                pointRadius: 3,
                pointBackgroundColor: '#e94560',
                pointBorderColor: '#fff',
                pointBorderWidth: 1,
                fill: true,
                tension: 0.2,
            }]
        },
        options: {
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const idx = elements[0].index;
                    const point = race.position_history[idx];
                    showFramePreview(point.timestamp, point.position, race.race_number, point.relative_time);
                }
            },
            onHover: (event, elements) => {
                const canvas = event.native.target;
                canvas.style.cursor = elements.length ? 'pointer' : 'default';
            },
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    reverse: true,
                    min: 0.5,
                    max: 12.5,
                    ticks: {
                        stepSize: 1,
                        callback: v => ordinal(Math.round(v)),
                    },
                    grid: { color: 'rgba(255,255,255,0.05)' },
                },
                x: {
                    title: { display: true, text: 'Time (seconds)', color: '#888' },
                    grid: { color: 'rgba(255,255,255,0.03)' },
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => ordinal(ctx.parsed.y) + ' place',
                        title: items => items[0].label + 's into race',
                    }
                }
            }
        }
    });
});

// -- Overview: final positions bar chart --
if (RACES.length >= 2) {
    const overviewCtx = document.getElementById('chart-overview');
    if (overviewCtx) {
        const labels = RACES.map(r => 'Race ' + r.race_number);
        const data = RACES.map(r => r.final_position);
        const colors = data.map(p => {
            if (p === 1) return '#ffd700';
            if (p === 2) return '#c0c0c0';
            if (p === 3) return '#cd7f32';
            if (p <= 6) return '#4488ff';
            return '#e94560';
        });

        new Chart(overviewCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Final Position',
                    data: data,
                    backgroundColor: colors,
                    borderRadius: 6,
                    barThickness: 40,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        reverse: true,
                        min: 0,
                        max: 13,
                        ticks: {
                            stepSize: 1,
                            callback: v => v === 0 ? '' : ordinal(v),
                        },
                        grid: { color: 'rgba(255,255,255,0.05)' },
                    },
                    x: {
                        grid: { display: false },
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => ordinal(ctx.parsed.y) + ' place',
                        }
                    }
                }
            }
        });
    }
}

// -- Session timeline --
(function() {
    const ctx = document.getElementById('chart-timeline');
    if (!ctx || !FRAMES.length) return;

    const labels = FRAMES.map(f => f.timestamp);
    const data = FRAMES.map(f => f.scene === 'in_race' ? 1 : 0);

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'In Race',
                data: data,
                backgroundColor: data.map(v => v ? 'rgba(233, 69, 96, 0.7)' : 'rgba(100, 100, 140, 0.3)'),
                borderWidth: 0,
                barPercentage: 1.0,
                categoryPercentage: 1.0,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    display: false,
                    max: 1.2,
                },
                x: {
                    title: { display: true, text: 'Time (seconds)', color: '#888' },
                    grid: { display: false },
                    ticks: {
                        maxTicksLimit: 20,
                    }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => ctx.parsed.y === 1 ? 'In Race' : 'Not In Race',
                        title: items => items[0].label + 's',
                    }
                }
            }
        }
    });
})();

// -- Frame preview on chart click --
const VIDEO_SRC = 'gameplaytrimmed.mp4';
const videoOverlay = document.getElementById('frame-preview-overlay');
const frameVideoEl = document.getElementById('frame-preview-video');
const frameInfoEl = document.getElementById('frame-preview-info');

if (VIDEO_SRC) {
    frameVideoEl.src = VIDEO_SRC;
}

function showFramePreview(timestamp, position, raceNum, relativeTime) {
    if (!VIDEO_SRC) {
        alert('Video file not available. Re-run with --video to enable frame preview.');
        return;
    }
    frameVideoEl.currentTime = timestamp;
    frameInfoEl.innerHTML =
        '<div class="info-item"><span class="info-label">Race</span><span class="info-value">' + raceNum + '</span></div>' +
        '<div class="info-item"><span class="info-label">Race Time</span><span class="info-value">' + relativeTime + 's</span></div>' +
        '<div class="info-item"><span class="info-label">Video Time</span><span class="info-value">' + timestamp + 's</span></div>' +
        '<div class="info-item"><span class="info-label">Position</span><span class="info-value">' + ordinal(position) + '</span></div>';
    videoOverlay.classList.add('active');
    frameVideoEl.pause();
}

function closeFramePreview() {
    videoOverlay.classList.remove('active');
    frameVideoEl.pause();
}

videoOverlay.addEventListener('click', function(e) {
    if (e.target === videoOverlay) closeFramePreview();
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeFramePreview();
});
</script>
</body>
</html>