<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MK Intel ‚Äî Mario Kart Race Annotator</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg-0: #0B0B0F;
    --bg-1: #101018;
    --bg-2: #16161F;
    --bg-3: #1E1E2A;
    --bg-4: #262636;
    --border: #2A2A3A;
    --border-hi: #3A3A50;
    --text-1: #EEEEF2;
    --text-2: #B0B0C0;
    --text-3: #707088;
    --text-4: #50506A;
    --red: #E8364E;
    --red-dim: #E8364E33;
    --yellow: #F5C542;
    --yellow-dim: #F5C54233;
    --blue: #4A9EFF;
    --blue-dim: #4A9EFF33;
    --green: #3DD68C;
    --green-dim: #3DD68C33;
    --purple: #A86EFF;
    --purple-dim: #A86EFF33;
    --orange: #FF8B3E;
    --orange-dim: #FF8B3E33;
    --cyan: #36D6D6;
    --cyan-dim: #36D6D633;
    --pink: #FF5CA1;
    --pink-dim: #FF5CA133;
    --mono: 'JetBrains Mono', monospace;
    --sans: 'Outfit', sans-serif;
  }
  body {
    font-family: var(--sans); background: var(--bg-0); color: var(--text-1);
    font-size: 13px; overflow: hidden; height: 100vh; width: 100vw;
  }
  input, select, button, textarea { font-family: inherit; }
  button { cursor: pointer; }

  /* === LAYOUT === */
  .app { display: flex; flex-direction: column; height: 100vh; }

  /* Top Bar */
  .topbar {
    height: 50px; display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; border-bottom: 1px solid var(--border); background: var(--bg-1);
    flex-shrink: 0;
  }
  .topbar-left { display: flex; align-items: center; gap: 14px; }
  .logo {
    font-weight: 900; font-size: 18px; letter-spacing: -0.03em;
    background: linear-gradient(135deg, var(--red), var(--orange));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .logo-sub { font-size: 11px; color: var(--text-3); font-weight: 500; letter-spacing: 0.06em; text-transform: uppercase; }
  .topbar-center { display: flex; align-items: center; gap: 10px; }
  .mode-badge {
    padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;
    letter-spacing: 0.04em; text-transform: uppercase;
  }
  .mode-idle { background: var(--bg-3); color: var(--text-3); }
  .mode-active { background: var(--green-dim); color: var(--green); animation: pulse-badge 2s ease-in-out infinite; }
  @keyframes pulse-badge { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }
  .topbar-right { display: flex; align-items: center; gap: 8px; }
  .stat-chip {
    padding: 4px 10px; border-radius: 6px; background: var(--bg-3);
    font-size: 11px; font-family: var(--mono); color: var(--text-2);
  }
  .btn-export {
    padding: 7px 16px; border-radius: 8px; background: var(--red); color: #fff;
    border: none; font-size: 12px; font-weight: 700; letter-spacing: 0.02em;
    transition: all 0.15s;
  }
  .btn-export:hover { filter: brightness(1.15); transform: translateY(-1px); }

  .main { display: flex; flex: 1; overflow: hidden; }

  /* === VIDEO AREA === */
  .video-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }
  .video-container {
    flex: 1; position: relative; overflow: hidden; background: var(--bg-0);
    background-image: radial-gradient(circle at 50% 50%, #14141E 0%, #0B0B0F 100%);
  }

  /* Drop Zone */
  .drop-zone {
    position: absolute; inset: 0; display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 20px; cursor: pointer;
    transition: all 0.3s;
  }
  .drop-zone:hover .drop-icon { border-color: var(--red); transform: scale(1.05); }
  .drop-icon {
    width: 140px; height: 140px; border-radius: 32px;
    border: 2px dashed var(--border);
    display: flex; align-items: center; justify-content: center;
    background: var(--bg-2); transition: all 0.3s; position: relative; overflow: hidden;
  }
  .drop-icon::before {
    content: ''; position: absolute; inset: 0;
    background: conic-gradient(from 0deg, transparent, var(--red-dim), transparent);
    animation: rotate-bg 4s linear infinite; opacity: 0.5;
  }
  @keyframes rotate-bg { to { transform: rotate(360deg); } }
  .drop-icon span { font-size: 48px; position: relative; z-index: 1; }
  .drop-title { font-weight: 700; font-size: 18px; color: var(--text-2); }
  .drop-sub { font-size: 12px; color: var(--text-4); }

  #video-el { position: absolute; object-fit: contain; }
  #annotation-canvas { position: absolute; z-index: 2; }

  /* Bbox */
  .place-bbox {
    position: absolute; border: 2px solid var(--yellow); border-radius: 4px;
    background: var(--yellow-dim); pointer-events: none;
  }
  .place-bbox-label {
    position: absolute; transform: translateY(-100%);
    background: var(--yellow); color: #000; padding: 1px 8px;
    border-radius: 4px 4px 0 0; font-size: 10px; font-weight: 700;
    font-family: var(--mono); pointer-events: none;
  }
  .draw-preview {
    position: absolute; border: 2px dashed var(--yellow);
    border-radius: 4px; background: var(--yellow-dim); pointer-events: none;
  }
  .bbox-corner {
    position: absolute; width: 8px; height: 8px; border-radius: 2px;
    background: #fff; border: 2px solid var(--yellow);
    transform: translate(-50%, -50%); pointer-events: none;
  }

  /* === TIMELINE === */
  .timeline {
    border-top: 1px solid var(--border); background: var(--bg-1);
    padding: 10px 20px; flex-shrink: 0;
  }
  .scrubber-wrap { position: relative; height: 28px; margin-bottom: 8px; }
  .event-marker {
    position: absolute; top: 2px; bottom: 2px; width: 3px;
    border-radius: 2px; z-index: 1; opacity: 0.8;
  }
  .scrubber {
    width: 100%; height: 100%; cursor: pointer;
    -webkit-appearance: none; appearance: none;
    background: transparent; position: relative; z-index: 2;
  }
  .scrubber::-webkit-slider-runnable-track { height: 4px; background: var(--bg-4); border-radius: 2px; }
  .scrubber::-webkit-slider-thumb {
    -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%;
    background: var(--red); margin-top: -6px; cursor: pointer;
    box-shadow: 0 0 12px var(--red-dim);
  }
  .scrubber::-moz-range-track { height: 4px; background: var(--bg-4); border-radius: 2px; border: none; }
  .scrubber::-moz-range-thumb {
    width: 16px; height: 16px; border-radius: 50%;
    background: var(--red); cursor: pointer; border: none;
  }
  .controls { display: flex; align-items: center; gap: 6px; }
  .c-btn {
    width: 34px; height: 34px; border-radius: 8px;
    border: 1px solid var(--border); background: var(--bg-2);
    color: var(--text-2); font-size: 14px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.12s;
  }
  .c-btn:hover { background: var(--bg-3); border-color: var(--border-hi); }
  .c-play {
    width: 42px; height: 42px; font-size: 18px;
    background: var(--red); color: #fff; border: none; border-radius: 10px;
  }
  .c-play:hover { filter: brightness(1.15); }
  .time-info {
    margin-left: 14px; font-family: var(--mono); font-size: 12px;
    color: var(--text-2); display: flex; gap: 14px; align-items: center;
  }
  .frame-hl { color: var(--yellow); font-weight: 600; }
  .ctrl-right { margin-left: auto; display: flex; align-items: center; gap: 8px; }
  .ctrl-label { font-size: 11px; color: var(--text-4); }
  .ctrl-select {
    padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border);
    background: var(--bg-2); color: var(--text-2);
    font-size: 11px; font-family: var(--mono); outline: none;
  }

  /* === RIGHT PANEL === */
  .panel {
    width: 340px; border-left: 1px solid var(--border); background: var(--bg-1);
    display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0;
  }

  /* Workflow Bar */
  .workflow-bar {
    padding: 14px; border-bottom: 1px solid var(--border);
    display: flex; gap: 8px;
  }
  .btn-start {
    flex: 1; padding: 10px; border-radius: 10px; border: none;
    font-size: 13px; font-weight: 700; letter-spacing: 0.03em;
    transition: all 0.2s;
  }
  .btn-start-go { background: var(--green); color: #000; }
  .btn-start-go:hover { filter: brightness(1.1); transform: translateY(-1px); }
  .btn-submit { background: var(--blue); color: #fff; }
  .btn-submit:hover { filter: brightness(1.1); transform: translateY(-1px); }
  .btn-skip { background: var(--bg-3); color: var(--text-2); }
  .btn-skip:hover { background: var(--bg-4); }

  /* Panel Sections */
  .p-section { padding: 14px; border-bottom: 1px solid var(--border); }
  .p-title {
    font-size: 10px; font-weight: 700; color: var(--text-4);
    text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 10px;
  }

  /* Event Flags */
  .event-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
  .event-btn {
    padding: 10px 8px; border-radius: 10px; border: 1.5px solid var(--border);
    background: var(--bg-2); color: var(--text-2); font-size: 12px; font-weight: 600;
    display: flex; align-items: center; gap: 8px; transition: all 0.15s;
    position: relative; overflow: hidden;
  }
  .event-btn:hover { border-color: var(--border-hi); background: var(--bg-3); transform: translateY(-1px); }
  .event-btn.flagged { animation: flag-flash 0.3s ease-out; }
  @keyframes flag-flash { 0% { transform: scale(0.95); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
  .event-btn .icon { font-size: 18px; flex-shrink: 0; }
  .event-btn .label { line-height: 1.2; }
  .event-btn.full-width { grid-column: 1 / -1; }

  /* Place Tracking */
  .place-section { display: flex; align-items: center; gap: 10px; }
  .bbox-toggle {
    padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 600;
    border: 1.5px solid var(--yellow); color: var(--yellow); background: transparent;
    transition: all 0.15s;
  }
  .bbox-toggle.active { background: var(--yellow-dim); }
  .bbox-toggle:hover { background: var(--yellow-dim); }
  .bbox-status { font-size: 11px; color: var(--text-3); font-family: var(--mono); }

  /* Race Result */
  .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .result-field label {
    display: block; font-size: 10px; font-weight: 600; color: var(--text-3);
    margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.06em;
  }
  .result-field input, .result-field select {
    width: 100%; padding: 7px 10px; border-radius: 8px;
    border: 1px solid var(--border); background: var(--bg-2);
    color: var(--text-1); font-size: 13px; font-family: var(--mono);
    outline: none; transition: border-color 0.15s;
  }
  .result-field input:focus, .result-field select:focus { border-color: var(--blue); }
  .result-field.full { grid-column: 1 / -1; }

  /* Event Log */
  .event-log { flex: 1; overflow-y: auto; padding: 14px; }
  .log-empty {
    padding: 24px; text-align: center; color: var(--text-4); font-size: 12px;
    border: 1px dashed var(--border); border-radius: 10px; line-height: 1.6;
  }
  .log-item {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 10px; border-radius: 8px; margin-bottom: 4px;
    background: var(--bg-2); border: 1px solid var(--border);
    cursor: pointer; transition: all 0.12s;
  }
  .log-item:hover { background: var(--bg-3); border-color: var(--border-hi); }
  .log-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }
  .log-info { flex: 1; min-width: 0; }
  .log-label { font-size: 12px; font-weight: 600; }
  .log-meta { font-size: 10px; color: var(--text-3); font-family: var(--mono); margin-top: 1px; }
  .log-delete {
    width: 22px; height: 22px; border-radius: 5px; border: none;
    background: transparent; color: var(--text-4); font-size: 12px;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: all 0.12s;
  }
  .log-item:hover .log-delete { opacity: 1; }
  .log-delete:hover { color: var(--red); background: var(--red-dim); }

  /* Keyboard Hints */
  .kb-bar {
    padding: 8px 14px; border-top: 1px solid var(--border);
    font-size: 10px; color: var(--text-4); display: flex; flex-wrap: wrap;
    gap: 4px 14px; font-family: var(--mono);
  }
  kbd {
    display: inline-block; padding: 1px 5px; border-radius: 4px;
    background: var(--bg-3); border: 1px solid var(--border);
    font-size: 9px; font-family: var(--mono); color: var(--text-3);
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--bg-4); border-radius: 3px; }
  .drag-over .drop-icon { border-color: var(--red) !important; }

  .hidden { display: none !important; }
</style>
</head>
<body>
<div class="app">
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="topbar-left">
      <div>
        <div class="logo">MK INTEL</div>
        <div class="logo-sub" id="file-name">Mario Kart Race Annotator</div>
      </div>
    </div>
    <div class="topbar-center">
      <div class="mode-badge mode-idle" id="mode-badge">IDLE</div>
    </div>
    <div class="topbar-right">
      <div class="stat-chip" id="stat-chip">0 events logged</div>
      <button class="btn-export" onclick="exportJSON()" id="btn-export" style="display:none">Export JSON</button>
    </div>
  </div>

  <div class="main">
    <!-- VIDEO AREA -->
    <div class="video-area">
      <div class="video-container" id="video-container"
           ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
        <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
          <div class="drop-icon"><span>üèéÔ∏è</span></div>
          <div class="drop-title">Drop a Mario Kart recording here</div>
          <div class="drop-sub">MP4, WebM, MOV ‚Äî then annotate races frame by frame</div>
        </div>
        <video id="video-el" style="display:none" muted></video>
        <div id="annotation-canvas" style="display:none"
             onmousedown="canvasMouseDown(event)"
             onmousemove="canvasMouseMove(event)"
             onmouseup="canvasMouseUp(event)"
             onmouseleave="canvasMouseUp(event)">
        </div>
        <input type="file" id="file-input" accept="video/*" style="display:none" onchange="handleUpload(event)">
      </div>

      <!-- TIMELINE -->
      <div class="timeline hidden" id="timeline">
        <div class="scrubber-wrap" id="scrubber-wrap">
          <input type="range" class="scrubber" id="scrubber" min="0" max="0" value="0" oninput="scrubTo(this.value)">
        </div>
        <div class="controls">
          <button class="c-btn" onclick="stepFrame(-10)" title="Back 10">‚è™</button>
          <button class="c-btn" onclick="stepFrame(-1)" title="Back 1">‚óÄ</button>
          <button class="c-btn c-play" id="play-btn" onclick="togglePlay()">‚ñ∂</button>
          <button class="c-btn" onclick="stepFrame(1)" title="Forward 1">‚ñ∂</button>
          <button class="c-btn" onclick="stepFrame(10)" title="Forward 10">‚è©</button>
          <div class="time-info">
            <span id="time-display">0:00.00 / 0:00.00</span>
            <span style="color:var(--text-4)">¬∑</span>
            <span>Frame <span class="frame-hl" id="frame-display">0</span> / <span id="total-frames">0</span></span>
          </div>
          <div class="ctrl-right">
            <span class="ctrl-label">FPS</span>
            <select class="ctrl-select" id="fps-select" onchange="changeFps(this.value)">
              <option value="24">24</option><option value="25">25</option>
              <option value="29.97">29.97</option><option value="30" selected>30</option>
              <option value="60">60</option>
            </select>
            <span class="ctrl-label" style="margin-left:6px">Speed</span>
            <select class="ctrl-select" id="speed-select" onchange="changeSpeed(this.value)">
              <option value="0.25">0.25√ó</option><option value="0.5">0.5√ó</option>
              <option value="1" selected>1√ó</option><option value="1.5">1.5√ó</option>
              <option value="2">2√ó</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="panel hidden" id="panel">
      <!-- Workflow -->
      <div class="workflow-bar" id="workflow-bar">
        <button class="btn-start btn-start-go" id="btn-start" onclick="startAnnotation()">‚ñ∂ Start Annotating</button>
      </div>

      <!-- Event Flags -->
      <div class="p-section" id="event-section">
        <div class="p-title">‚ö° Flag Event at Current Frame</div>
        <div class="event-grid" id="event-grid">
          <button class="event-btn" onclick="flagEvent('lightning')" id="ev-lightning">
            <span class="icon">‚ö°</span><span class="label">Lightning</span>
          </button>
          <button class="event-btn" onclick="flagEvent('blue_shell')" id="ev-blue_shell">
            <span class="icon">üîµ</span><span class="label">Blue Shell</span>
          </button>
          <button class="event-btn" onclick="flagEvent('star')" id="ev-star">
            <span class="icon">‚≠ê</span><span class="label">Star</span>
          </button>
          <button class="event-btn" onclick="flagEvent('bullet_bill')" id="ev-bullet_bill">
            <span class="icon">üöÄ</span><span class="label">Bullet Bill</span>
          </button>
          <button class="event-btn" onclick="flagEvent('item_pickup')" id="ev-item_pickup">
            <span class="icon">üì¶</span><span class="label">Item Pickup</span>
          </button>
          <button class="event-btn" onclick="flagEvent('fall')" id="ev-fall">
            <span class="icon">üíÄ</span><span class="label">Fall / OOB</span>
          </button>
          <button class="event-btn full-width" onclick="flagEvent('race_over')" id="ev-race_over" style="border-color:var(--red-dim);">
            <span class="icon">üèÅ</span><span class="label">Race Over</span>
          </button>
        </div>
      </div>

      <!-- Place Card Tracking -->
      <div class="p-section">
        <div class="p-title">üìç Place Card Tracking</div>
        <div class="place-section">
          <button class="bbox-toggle" id="bbox-toggle" onclick="toggleBboxDraw()">Draw Box</button>
          <span class="bbox-status" id="bbox-status">No box on this frame</span>
          <button class="bbox-toggle" id="bbox-clear" onclick="clearBbox()" style="border-color:var(--text-4);color:var(--text-4);display:none;font-size:11px;padding:6px 10px;">Clear</button>
        </div>
      </div>

      <!-- Race Result -->
      <div class="p-section" id="result-section">
        <div class="p-title">üèÜ Race Result</div>
        <div class="result-grid">
          <div class="result-field">
            <label>Finish Place</label>
            <select id="res-place">
              <option value="">‚Äî</option>
              <option value="1">1st</option><option value="2">2nd</option>
              <option value="3">3rd</option><option value="4">4th</option>
              <option value="5">5th</option><option value="6">6th</option>
              <option value="7">7th</option><option value="8">8th</option>
              <option value="9">9th</option><option value="10">10th</option>
              <option value="11">11th</option><option value="12">12th</option>
            </select>
          </div>
          <div class="result-field">
            <label>Rating Before</label>
            <input type="number" id="res-rating-before" placeholder="e.g. 12400">
          </div>
          <div class="result-field">
            <label>Rating Change</label>
            <input type="text" id="res-rating-change" placeholder="e.g. +14 or -22">
          </div>
          <div class="result-field">
            <label>
              <button onclick="saveRaceResult()" style="background:var(--blue);color:#fff;border:none;border-radius:6px;padding:5px 14px;font-size:11px;font-weight:700;cursor:pointer;">Save Result</button>
            </label>
          </div>
        </div>
      </div>

      <!-- Event Log -->
      <div class="event-log" id="event-log">
        <div class="p-title">üìã Event Log</div>
        <div id="log-content">
          <div class="log-empty">No events logged yet.<br>Navigate the video and flag events as you see them.</div>
        </div>
      </div>

      <!-- Keyboard Hints -->
      <div class="kb-bar">
        <span><kbd>Space</kbd> Play</span>
        <span><kbd>‚Üê‚Üí</kbd> Step</span>
        <span><kbd>‚áß‚Üê‚Üí</kbd> √ó10</span>
        <span><kbd>B</kbd> Box</span>
        <span><kbd>1-7</kbd> Flags</span>
        <span><kbd>Enter</kbd> Submit</span>
      </div>
    </div>
  </div>
</div>

<script>
// ===================== STATE =====================
let videoSrc = null, videoName = "", isPlaying = false;
let currentTime = 0, duration = 0, fps = 30, currentFrame = 0;
let animFrame = null;

// Annotation state
let events = [];          // { type, frame, time, id }
let placeBoxes = {};      // frame -> { x1, y1, x2, y2 }
let raceResult = null;    // { place, ratingBefore, ratingChange, frame }

// Drawing state
let bboxDrawMode = false;
let isDrawing = false, drawStart = null, drawCurrent = null;

// Workflow
let annotating = false;

// Video sizing
let videoSize = { w: 0, h: 0 };
let canvasOffset = { x: 0, y: 0 };

// DOM
const videoEl = document.getElementById("video-el");
const aCanvas = document.getElementById("annotation-canvas");
const container = document.getElementById("video-container");
const scrubber = document.getElementById("scrubber");

const EVENT_META = {
  lightning:   { icon: "‚ö°", label: "Lightning",   color: "var(--yellow)", colorHex: "#F5C542" },
  blue_shell:  { icon: "üîµ", label: "Blue Shell",   color: "var(--blue)",   colorHex: "#4A9EFF" },
  star:        { icon: "‚≠ê", label: "Star",         color: "var(--orange)", colorHex: "#FF8B3E" },
  bullet_bill: { icon: "üöÄ", label: "Bullet Bill",  color: "var(--purple)", colorHex: "#A86EFF" },
  item_pickup: { icon: "üì¶", label: "Item Pickup",  color: "var(--cyan)",   colorHex: "#36D6D6" },
  fall:        { icon: "üíÄ", label: "Fall / OOB",   color: "var(--pink)",   colorHex: "#FF5CA1" },
  race_over:   { icon: "üèÅ", label: "Race Over",    color: "var(--red)",    colorHex: "#E8364E" },
};

// ===================== HELPERS =====================
function formatTime(t) {
  const m = Math.floor(t / 60), s = Math.floor(t % 60), ms = Math.floor((t % 1) * 100);
  return `${m}:${s.toString().padStart(2,"0")}.${ms.toString().padStart(2,"0")}`;
}
function getFrameBox() { return placeBoxes[currentFrame] || null; }

// ===================== VIDEO LOAD =====================
function loadVideo(file) {
  if (videoSrc) URL.revokeObjectURL(videoSrc);
  videoSrc = URL.createObjectURL(file);
  videoName = file.name;
  videoEl.src = videoSrc;
  events = []; placeBoxes = {}; raceResult = null; annotating = false;
  currentTime = 0; currentFrame = 0;
  document.getElementById("file-name").textContent = file.name;
}
function handleUpload(e) { if (e.target.files[0]) loadVideo(e.target.files[0]); }
function handleDrop(e) {
  e.preventDefault(); container.classList.remove("drag-over");
  const f = e.dataTransfer.files[0];
  if (f && f.type.startsWith("video/")) loadVideo(f);
}
function handleDragOver(e) { e.preventDefault(); container.classList.add("drag-over"); }
function handleDragLeave() { container.classList.remove("drag-over"); }

videoEl.addEventListener("loadedmetadata", () => {
  duration = videoEl.duration;
  scrubber.max = Math.floor(duration * fps);
  document.getElementById("total-frames").textContent = Math.floor(duration * fps);
  document.getElementById("drop-zone").style.display = "none";
  videoEl.style.display = "block";
  aCanvas.style.display = "block";
  document.getElementById("timeline").classList.remove("hidden");
  document.getElementById("panel").classList.remove("hidden");
  document.getElementById("btn-export").style.display = "inline-block";
  updateVideoSize();
  updateTimeDisplay();
  renderCanvas();
  renderLog();
  updateWorkflow();
});
videoEl.addEventListener("ended", () => { isPlaying = false; document.getElementById("play-btn").textContent = "‚ñ∂"; });

function updateVideoSize() {
  if (!videoEl.videoWidth) return;
  const rect = container.getBoundingClientRect();
  const va = videoEl.videoWidth / videoEl.videoHeight, ca = rect.width / rect.height;
  let w, h;
  if (va > ca) { w = rect.width; h = w / va; } else { h = rect.height; w = h * va; }
  videoSize = { w, h };
  canvasOffset = { x: (rect.width - w) / 2, y: (rect.height - h) / 2 };
  videoEl.style.left = canvasOffset.x + "px"; videoEl.style.top = canvasOffset.y + "px";
  videoEl.style.width = w + "px"; videoEl.style.height = h + "px";
  aCanvas.style.left = canvasOffset.x + "px"; aCanvas.style.top = canvasOffset.y + "px";
  aCanvas.style.width = w + "px"; aCanvas.style.height = h + "px";
}
window.addEventListener("resize", updateVideoSize);

// ===================== PLAYBACK =====================
function togglePlay() {
  if (!videoSrc) return;
  if (isPlaying) videoEl.pause(); else videoEl.play();
  isPlaying = !isPlaying;
  document.getElementById("play-btn").textContent = isPlaying ? "‚è∏" : "‚ñ∂";
  if (isPlaying) syncLoop();
}
function syncLoop() {
  if (!isPlaying) return;
  currentTime = videoEl.currentTime;
  currentFrame = Math.floor(currentTime * fps);
  scrubber.value = currentFrame;
  updateTimeDisplay(); renderCanvas();
  animFrame = requestAnimationFrame(syncLoop);
}
function seekToFrame(f) {
  const t = f / fps; videoEl.currentTime = t;
  currentTime = t; currentFrame = f; scrubber.value = f;
  updateTimeDisplay(); renderCanvas();
}
function stepFrame(d) {
  if (isPlaying) { videoEl.pause(); isPlaying = false; document.getElementById("play-btn").textContent = "‚ñ∂"; }
  seekToFrame(Math.max(0, Math.min(Math.floor(duration * fps), currentFrame + d)));
}
function scrubTo(v) { seekToFrame(parseInt(v)); }
function changeFps(v) {
  fps = parseFloat(v); scrubber.max = Math.floor(duration * fps);
  document.getElementById("total-frames").textContent = Math.floor(duration * fps);
  currentFrame = Math.floor(currentTime * fps); scrubber.value = currentFrame;
  updateTimeDisplay();
}
function changeSpeed(v) { videoEl.playbackRate = parseFloat(v); }
function updateTimeDisplay() {
  document.getElementById("time-display").textContent = formatTime(currentTime) + " / " + formatTime(duration);
  document.getElementById("frame-display").textContent = currentFrame;
  // Update bbox status
  const box = getFrameBox();
  document.getElementById("bbox-status").textContent = box ? `Box set (${box.x1.toFixed(0)}%, ${box.y1.toFixed(0)}%)` : "No box on this frame";
  document.getElementById("bbox-clear").style.display = box ? "inline-block" : "none";
}

// ===================== WORKFLOW =====================
function startAnnotation() {
  annotating = true;
  updateWorkflow();
  const badge = document.getElementById("mode-badge");
  badge.textContent = "ANNOTATING";
  badge.className = "mode-badge mode-active";
}
function submitAndNext() {
  stepFrame(1);
}
function updateWorkflow() {
  const bar = document.getElementById("workflow-bar");
  if (!annotating) {
    bar.innerHTML = `<button class="btn-start btn-start-go" onclick="startAnnotation()">‚ñ∂ Start Annotating</button>`;
  } else {
    bar.innerHTML = `
      <button class="btn-start btn-skip" onclick="stepFrame(-1)">‚Üê Back</button>
      <button class="btn-start btn-submit" onclick="submitAndNext()">Submit & Next ‚Üí</button>
      <button class="btn-start btn-skip" onclick="stepFrame(10)" style="flex:0.5">Skip 10 ‚Üí</button>
    `;
  }
}

// ===================== EVENT FLAGS =====================
function flagEvent(type) {
  const ev = { type, frame: currentFrame, time: currentTime, id: Date.now() };
  events.push(ev);
  events.sort((a, b) => a.frame - b.frame);

  // Flash animation
  const btn = document.getElementById("ev-" + type);
  btn.classList.remove("flagged");
  void btn.offsetWidth;
  btn.classList.add("flagged");

  renderLog();
  renderTimelineMarkers();
  updateStats();
}
function deleteEvent(id) {
  events = events.filter(e => e.id !== id);
  renderLog(); renderTimelineMarkers(); updateStats();
}
function updateStats() {
  document.getElementById("stat-chip").textContent =
    `${events.length} event${events.length !== 1 ? "s" : ""} ¬∑ ${Object.keys(placeBoxes).length} boxes`;
}

// ===================== PLACE BBOX =====================
function toggleBboxDraw() {
  bboxDrawMode = !bboxDrawMode;
  const btn = document.getElementById("bbox-toggle");
  btn.classList.toggle("active", bboxDrawMode);
  btn.textContent = bboxDrawMode ? "Drawing..." : "Draw Box";
  aCanvas.style.cursor = bboxDrawMode ? "crosshair" : "default";
}
function clearBbox() {
  delete placeBoxes[currentFrame];
  renderCanvas(); updateTimeDisplay(); updateStats();
}
function toCoords(e) {
  const r = aCanvas.getBoundingClientRect();
  return { x: ((e.clientX - r.left) / r.width) * 100, y: ((e.clientY - r.top) / r.height) * 100 };
}
function canvasMouseDown(e) {
  if (!bboxDrawMode) return;
  isDrawing = true;
  drawStart = toCoords(e);
  drawCurrent = drawStart;
}
function canvasMouseMove(e) {
  if (!isDrawing) return;
  drawCurrent = toCoords(e);
  renderCanvas();
}
function canvasMouseUp() {
  if (!isDrawing) return;
  if (drawStart && drawCurrent) {
    const w = Math.abs(drawCurrent.x - drawStart.x), h = Math.abs(drawCurrent.y - drawStart.y);
    if (w > 1 && h > 1) {
      placeBoxes[currentFrame] = {
        x1: Math.min(drawStart.x, drawCurrent.x), y1: Math.min(drawStart.y, drawCurrent.y),
        x2: Math.max(drawStart.x, drawCurrent.x), y2: Math.max(drawStart.y, drawCurrent.y),
      };
      // Auto-exit draw mode
      bboxDrawMode = false;
      document.getElementById("bbox-toggle").classList.remove("active");
      document.getElementById("bbox-toggle").textContent = "Draw Box";
      aCanvas.style.cursor = "default";
      updateStats();
    }
  }
  isDrawing = false; drawStart = null; drawCurrent = null;
  renderCanvas(); updateTimeDisplay();
}

// ===================== RACE RESULT =====================
function saveRaceResult() {
  const place = document.getElementById("res-place").value;
  const rBefore = document.getElementById("res-rating-before").value;
  const rChange = document.getElementById("res-rating-change").value;
  raceResult = {
    place: place || null,
    ratingBefore: rBefore ? parseInt(rBefore) : null,
    ratingChange: rChange || null,
    frame: currentFrame, time: currentTime,
  };
  // Visual feedback
  const btn = event.target;
  const orig = btn.textContent;
  btn.textContent = "‚úì Saved!";
  btn.style.background = "var(--green)";
  setTimeout(() => { btn.textContent = orig; btn.style.background = "var(--blue)"; }, 1200);
}

// ===================== RENDERING =====================
function renderCanvas() {
  let html = "";
  // Place bounding box for current frame
  const box = getFrameBox();
  if (box) {
    const l = box.x1, t = box.y1, w = box.x2 - box.x1, h = box.y2 - box.y1;
    html += `<div class="place-bbox" style="left:${l}%;top:${t}%;width:${w}%;height:${h}%"></div>`;
    html += `<div class="place-bbox-label" style="left:${l}%;top:${t}%">PLACE CARD</div>`;
    [[l,t],[l+w,t],[l,t+h],[l+w,t+h]].forEach(([cx,cy]) => {
      html += `<div class="bbox-corner" style="left:${cx}%;top:${cy}%"></div>`;
    });
  }
  // Draw preview
  if (isDrawing && drawStart && drawCurrent) {
    html += `<div class="draw-preview" style="
      left:${Math.min(drawStart.x,drawCurrent.x)}%;top:${Math.min(drawStart.y,drawCurrent.y)}%;
      width:${Math.abs(drawCurrent.x-drawStart.x)}%;height:${Math.abs(drawCurrent.y-drawStart.y)}%;
    "></div>`;
  }
  // Event indicators on current frame
  const frameEvents = events.filter(e => e.frame === currentFrame);
  if (frameEvents.length) {
    html += `<div style="position:absolute;top:8px;right:8px;display:flex;flex-direction:column;gap:4px;pointer-events:none;">`;
    frameEvents.forEach(e => {
      const m = EVENT_META[e.type];
      html += `<div style="background:${m.colorHex}22;border:1px solid ${m.colorHex};border-radius:8px;padding:4px 10px;font-size:12px;font-weight:700;color:${m.colorHex};backdrop-filter:blur(4px);">
        ${m.icon} ${m.label}
      </div>`;
    });
    html += `</div>`;
  }
  aCanvas.innerHTML = html;
}

function renderLog() {
  const el = document.getElementById("log-content");
  if (events.length === 0) {
    el.innerHTML = `<div class="log-empty">No events logged yet.<br>Navigate the video and flag events as you see them.</div>`;
    return;
  }
  el.innerHTML = events.map(e => {
    const m = EVENT_META[e.type];
    return `<div class="log-item" onclick="seekToFrame(${e.frame})">
      <div class="log-dot" style="background:${m.colorHex}"></div>
      <div class="log-info">
        <div class="log-label">${m.icon} ${m.label}</div>
        <div class="log-meta">Frame ${e.frame} ¬∑ ${formatTime(e.time)}</div>
      </div>
      <button class="log-delete" onclick="event.stopPropagation();deleteEvent(${e.id})" title="Remove">‚úï</button>
    </div>`;
  }).join("");
}

function renderTimelineMarkers() {
  document.querySelectorAll(".event-marker").forEach(el => el.remove());
  const wrap = document.getElementById("scrubber-wrap");
  const maxF = Math.floor(duration * fps);
  events.forEach(e => {
    const pos = (e.frame / maxF) * 100;
    const m = EVENT_META[e.type];
    const marker = document.createElement("div");
    marker.className = "event-marker";
    marker.style.left = pos + "%";
    marker.style.background = m.colorHex;
    marker.title = `${m.label} @ frame ${e.frame}`;
    wrap.appendChild(marker);
  });
  // Also mark place boxes
  Object.keys(placeBoxes).forEach(f => {
    const pos = (parseInt(f) / maxF) * 100;
    const marker = document.createElement("div");
    marker.className = "event-marker";
    marker.style.left = pos + "%";
    marker.style.background = "#F5C542";
    marker.style.opacity = "0.4";
    marker.style.width = "2px";
    wrap.appendChild(marker);
  });
}

// ===================== EXPORT =====================
function exportJSON() {
  const data = {
    video: videoName,
    fps,
    totalFrames: Math.floor(duration * fps),
    duration: duration,
    raceResult: raceResult,
    placeBoxes: Object.entries(placeBoxes).map(([frame, box]) => ({
      frame: parseInt(frame),
      time: (parseInt(frame) / fps).toFixed(3),
      bbox: { x1: box.x1.toFixed(2), y1: box.y1.toFixed(2), x2: box.x2.toFixed(2), y2: box.y2.toFixed(2) },
    })),
    events: events.map(e => ({
      type: e.type,
      label: EVENT_META[e.type].label,
      frame: e.frame,
      time: (e.frame / fps).toFixed(3),
    })),
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url;
  a.download = `${videoName || "mk-race"}-annotations.json`;
  a.click(); URL.revokeObjectURL(url);
}

// ===================== KEYBOARD =====================
document.addEventListener("keydown", (e) => {
  if (e.target.tagName === "INPUT" || e.target.tagName === "SELECT" || e.target.tagName === "TEXTAREA") return;
  const key = e.key;
  switch (key) {
    case " ": e.preventDefault(); togglePlay(); break;
    case "ArrowRight": e.preventDefault(); stepFrame(e.shiftKey ? 10 : 1); break;
    case "ArrowLeft": e.preventDefault(); stepFrame(e.shiftKey ? -10 : -1); break;
    case "b": case "B": toggleBboxDraw(); break;
    case "Enter":
      e.preventDefault();
      if (annotating) submitAndNext();
      else startAnnotation();
      break;
    case "1": flagEvent("lightning"); break;
    case "2": flagEvent("blue_shell"); break;
    case "3": flagEvent("star"); break;
    case "4": flagEvent("bullet_bill"); break;
    case "5": flagEvent("item_pickup"); break;
    case "6": flagEvent("fall"); break;
    case "7": flagEvent("race_over"); break;
  }
});

function escapeHtml(t) { const d = document.createElement("div"); d.textContent = t; return d.innerHTML; }
</script>
</body>
</html>